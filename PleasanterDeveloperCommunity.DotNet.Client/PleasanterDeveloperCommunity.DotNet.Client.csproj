<Project Sdk="Microsoft.NET.Sdk">

<!-- Gitブランチに基づいてビルド構成を自動切替 -->
<Target Name="GetGitBranch" BeforeTargets="BeforeBuild">
  <Exec Command="git rev-parse --abbrev-ref HEAD" ConsoleToMSBuild="true" StandardOutputImportance="low" IgnoreExitCode="true">
    <Output TaskParameter="ConsoleOutput" PropertyName="GitBranch" />
  </Exec>
  <Message Importance="high" Text="現在のGitブランチ: $(GitBranch)" />
</Target>

<PropertyGroup>
  <TargetFramework>netstandard2.1</TargetFramework>
  <RootNamespace>PleasanterDeveloperCommunity.DotNet.Client</RootNamespace>
  <Nullable>enable</Nullable>
  <LangVersion>14</LangVersion>

  <!-- バージョン番号の自動生成 -->
  <VersionPrefix>1.0.0</VersionPrefix>
  <AssemblyVersion>$(VersionPrefix).$([System.DateTime]::UtcNow.ToString("yyMM"))</AssemblyVersion>
  <FileVersion>$(VersionPrefix).$([System.DateTime]::UtcNow.ToString("ddHH"))</FileVersion>
  <InformationalVersion>$(VersionPrefix)+$([System.DateTime]::UtcNow.ToString("yyyyMMdd.HHmmss"))</InformationalVersion>
</PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNet.WebApi.Client" Version="6.0.0" />
    <PackageReference Include="Newtonsoft.Json" Version="13.0.4" />
    <PackageReference Include="CsvHelper" Version="33.1.0" />
    <PackageReference Include="System.ComponentModel.Annotations" Version="5.0.0" />
    <PackageReference Include="System.Threading.Channels" Version="10.0.2" />
    <PackageReference Include="UUIDNext" Version="4.2.3" />
  </ItemGroup>

  <!-- mainブランチ時にdistフォルダへ配布用ファイルをコピー -->
  <PropertyGroup>
    <DistOutputPath>$(SolutionDir)dist</DistOutputPath>
  </PropertyGroup>

  <Target Name="CopyToDistFolder" AfterTargets="Build" Condition="'$(GitBranch)' == 'main'">
    <MakeDir Directories="$(DistOutputPath)" />
    <ItemGroup>
      <DistFiles Include="$(OutputPath)**\*.*" />
    </ItemGroup>
    <Copy SourceFiles="@(DistFiles)" DestinationFolder="$(DistOutputPath)\%(RecursiveDir)" SkipUnchangedFiles="true" />
    <Message Importance="high" Text="配布用ファイルを $(DistOutputPath) にコピーしました" />
  </Target>

</Project>
