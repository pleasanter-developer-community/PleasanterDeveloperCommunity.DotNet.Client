# レコードのインポート - items/{siteId}/import

## 概要

CSVファイルをインポートして、指定したサイトIDのテーブルにレコードを作成・更新します。

## 対応バージョン

- プリザンター 1.3.13.0以降
  - このライブラリの制約によるもの
- MigrationModeパラメータ: プリザンター 1.4.16.0以降

## メソッド

```csharp
// byte[]版
Task<ApiResponse<ImportResponse>> ImportAsync(long siteId, byte[] csvData, string fileName, Encoding? encoding = null, string? key = null, bool? migrationMode = null, TimeSpan? timeout = null)

// Stream版
Task<ApiResponse<ImportResponse>> ImportAsync(long siteId, Stream csvStream, string fileName, Encoding? encoding = null, string? key = null, bool? migrationMode = null, TimeSpan? timeout = null)

// ファイルパス版
Task<ApiResponse<ImportResponse>> ImportFromFileAsync(long siteId, string filePath, Encoding? encoding = null, string? key = null, bool? migrationMode = null, TimeSpan? timeout = null)

// リクエストオブジェクト使用版（byte[]）
Task<ApiResponse<ImportResponse>> ImportAsync(long siteId, ImportRequest request, byte[] csvData, string fileName, TimeSpan? timeout = null)

// リクエストオブジェクト使用版（Stream）
Task<ApiResponse<ImportResponse>> ImportAsync(long siteId, ImportRequest request, Stream csvStream, string fileName, TimeSpan? timeout = null)
```

## パラメータ

| 引数 | 型 | 必須 | 説明 |
|------|------|:----:|------|
| `siteId` | long | ✓ | サイトID |
| `csvData` | byte[] | ✓ | CSVファイルのバイナリデータ |
| `csvStream` | Stream | ✓ | CSVファイルのストリーム（byte[]の代わりに使用可能） |
| `filePath` | string | ✓ | CSVファイルのパス（ImportFromFileAsync用） |
| `fileName` | string | ✓ | ファイル名 |
| `encoding` | Encoding? | | CSVファイルのエンコーディング（`Encoding.UTF8` または `Encoding.GetEncoding(932)`、デフォルト: `Encoding.UTF8`） |
| `key` | string? | | キーが一致するレコードを更新する場合のキー項目（例: IssueId, ClassA など）。指定すると自動的に更新モードになります。 |
| `migrationMode` | bool? | | 移行モードでのインポートを実施する場合はtrue |
| `timeout` | TimeSpan? | | リクエストタイムアウト |

## 使用例

### 基本的なインポート（新規レコード作成）

```csharp
// CSVファイルを読み込んでインポート
var csvData = File.ReadAllBytes("import.csv");

var result = await client.ImportAsync(
    siteId: 123,
    csvData: csvData,
    fileName: "import.csv");

if (result.IsSuccess)
{
    Console.WriteLine($"メッセージ: {result.Message}");
}
```

### ファイルパスを指定してインポート（推奨）

```csharp
// ファイルパスを直接指定してインポート（最もシンプル）
var result = await client.ImportFromFileAsync(
    siteId: 123,
    filePath: @"C:\data\import.csv");

if (result.IsSuccess)
{
    Console.WriteLine($"メッセージ: {result.Message}");
}
```

### ファイルパスを指定して更新モードでインポート

```csharp
// ファイルパスを指定し、キーを指定して既存レコードを更新
var result = await client.ImportFromFileAsync(
    siteId: 123,
    filePath: @"C:\data\update.csv",
    key: "IssueId");
```

### UTF-8エンコーディングでインポート

```csharp
using System.Text;

var csvData = File.ReadAllBytes("import.csv");

var result = await client.ImportAsync(
    siteId: 123,
    csvData: csvData,
    fileName: "import.csv",
    encoding: Encoding.UTF8);  // 省略可能（デフォルト）
```

### Shift-JISエンコーディングでインポート

```csharp
using System.Text;

var csvData = File.ReadAllBytes("import_sjis.csv");

var result = await client.ImportAsync(
    siteId: 123,
    csvData: csvData,
    fileName: "import_sjis.csv",
    encoding: Encoding.GetEncoding(932));  // Shift-JIS
```

### キーが一致するレコードを更新

```csharp
// IssueIdをキーにして、既存レコードを更新
// keyを指定すると自動的に更新モードになります
var csvData = File.ReadAllBytes("update.csv");

var result = await client.ImportAsync(
    siteId: 123,
    csvData: csvData,
    fileName: "update.csv",
    key: "IssueId");

if (result.IsSuccess)
{
    Console.WriteLine($"結果: {result.Message}");
    // 例: "テーブル名: 50 件追加し、12 件更新しました。"
}
```

### 分類項目をキーにして更新

```csharp
// ClassA（分類A）をキーにして既存レコードを更新
var csvData = File.ReadAllBytes("update.csv");

var result = await client.ImportAsync(
    siteId: 123,
    csvData: csvData,
    fileName: "update.csv",
    key: "ClassA");
```

### 移行モードでインポート

```csharp
// 移行モードでインポート（作成日時や作成者などを保持）
var csvData = File.ReadAllBytes("migration.csv");

var result = await client.ImportAsync(
    siteId: 123,
    csvData: csvData,
    fileName: "migration.csv",
    migrationMode: true);
```

### Streamを使用したインポート

```csharp
// ファイルストリームを使用（大きなファイルに推奨）
using var stream = File.OpenRead("import.csv");

var result = await client.ImportAsync(
    siteId: 123,
    csvStream: stream,
    fileName: "import.csv",
    key: "IssueId");
```

### リクエストオブジェクト使用版

```csharp
using System.Text;
using PleasanterDeveloperCommunity.DotNet.Client.Models.Requests.Items;

var request = new ImportRequest
{
    Encoding = Encoding.UTF8,
    Key = "IssueId",  // Keyを指定すると自動的に更新モードになります
    MigrationMode = false
};

var csvData = File.ReadAllBytes("import.csv");

var result = await client.ImportAsync(
    siteId: 123,
    request: request,
    csvData: csvData,
    fileName: "import.csv");
```

## ImportRequestクラスのプロパティ

| プロパティ | 型 | 説明 |
|-----------|------|------|
| `Encoding` | Encoding? | CSVファイルのエンコーディング（UTF-8 または Shift-JIS のみサポート） |
| `Key` | string? | キーが一致するレコードを更新する場合のキー項目。指定すると自動的にUpdatableImport=trueになります。 |
| `MigrationMode` | bool? | 移行モードでのインポートを実施する場合はtrue |

## ImportResponseクラス

`RecordOperationResponseBase` を継承しています。レスポンスのメッセージ（`result.Message`）にインポート結果の詳細が含まれます。

## レスポンス例

```json
{
  "Id": 1234,
  "StatusCode": 200,
  "LimitPerDate": 1000,
  "LimitRemaining": 998,
  "Message": "テーブル名: 50 件追加し、12 件更新しました。"
}
```

## 注意事項

- `encoding` は `System.Text.Encoding` 型で指定します（UTF-8: `Encoding.UTF8`、Shift-JIS: `Encoding.GetEncoding(932)`）
- UTF-8 または Shift-JIS 以外のエンコーディングを指定すると `ArgumentException` がスローされます
- `key` を指定すると自動的に更新モード（UpdatableImport=true）になります
- `MigrationMode` はプリザンター 1.4.16.0以降で使用可能です
- インポートには対象サイトへの書き込み権限が必要です
